name: Manus PR Review

on:
  pull_request:
    types:
{%- for event in manus.trigger.on %}
      - {{ event }}
{%- endfor %}
{%- if manus.trigger.labels %}
    labels:
{%- for label in manus.trigger.labels %}
      - {{ label }}
{%- endfor %}
{%- endif %}

jobs:
  manus-review:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Read Prompts
        id: prompts
        run: |
          PROMPT=""
{% for prompt_file in manus.prompts %}
          PROMPT+=$(cat .ritual-pr/prompts/{{ prompt_file }})
          PROMPT+=$'\n\n'
{% endfor %}
          {% raw %}
          echo "COMBINED_PROMPT<<EOF" >> $GITHUB_OUTPUT
          echo "$PROMPT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Trigger Manus Review
        env:
          PROMPT: ${{ steps.prompts.outputs.COMBINED_PROMPT }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
          CONNECTOR_ID: ${{ secrets.MANUS_GITHUB_CONNECTOR_ID }}
        run: |
          jq -n \
            --arg prompt "$PROMPT" \
            --arg pr_url "$PR_URL" \
            --arg pr_number "$PR_NUMBER" \
            --arg repo "$REPO" \
            --arg connector_id "$CONNECTOR_ID" \
            '{
              prompt: ($prompt + "\n\nReview this pull request: " + $pr_url + "\n\n## Instructions\n\n1. **First, read existing PR comments** using the GitHub connector to see what has already been reviewed\n2. **Check if you (Manus AI) have already reviewed this PR** - look for comments starting with \"**Manus AI Review**\"\n3. **If you have already reviewed:**\n   - Read your previous review carefully\n   - Check which issues have been addressed and which remain\n   - Focus on NEW changes since your last review\n   - Update or supplement your previous feedback rather than repeating it\n   - Start with: \"**Manus AI Review - Update** - Following up on my previous review...\"\n4. **If this is your first review:**\n   - Start your comment: \"**Manus AI Review** - I've completed a comprehensive review of this PR\"\n5. Review the pull request thoroughly using the GitHub connector\n6. Include your detailed findings, recommendations, and action items\n7. Use the GitHub connector to post your comment to PR #" + $pr_number + " in repository " + $repo + "\n8. Format your comment in clear markdown with sections for different review areas"),
              taskMode: "agent",
              connectors: [$connector_id],
              agentProfile: "quality",
              createShareableLink: true
            }' | \
          curl --request POST \
            --url 'https://api.manus.ai/v1/tasks' \
            --header 'API_KEY: ${{ secrets.MANUS_API_KEY }}' \
            --header 'Content-Type: application/json' \
            --data @-
          {% endraw %}

